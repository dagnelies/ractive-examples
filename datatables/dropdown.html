<!doctype html>
<html>
<head>
	<!-- Bootstrap -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">
	<link href='https://fonts.googleapis.com/css?family=Voltaire' rel='stylesheet' type='text/css'>
	<!-- JQuery -->
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<!-- Ractive -->
	<script src='https://cdn.jsdelivr.net/npm/ractive'></script>
	<!-- Datatable -->
	<script src="datatable.js"></script>
	<!-- A bit of style -->
	<style>
		body {
			background-color:#eee;
			min-height:100%;
			font-family:Voltaire;
		}
		
		
		.autofill {
			position: relative;
		}
		
		.autofill > div {
			display: none;
			background-color:white;
			position:absolute;
			width: 100%;
			z-index: 1;
		}
		
		.autofill > input:focus + div {
			display: block;
		}
		
	</style>
</head>
<body>
	<div id="target" class="container"></div>

	<script id='template' type='text/ractive'>
		
		<div class="autofill">
			<input value="{{value}}" class="form-control" on-keypress="@.onkeypress(@event)" />
			<div>
				<datatable rows="{{filteredRows}}" fields="['name','email','age','isActive']" headers="['Name','Email', 'Age', 'Is active?']" selected="{{selected}}" selectedIndex="{{selectedIndex}}" navigable="true" selectable="true" />
			</div>
		</div>
		
		<h1>As component</h1>
		<input-grid value="{{value}}" rows="{{rows}}" fields="['name','email','age','isActive']" headers="['Name','Email', 'Age', 'Is active?']" selected="{{selected}}" />
		
		<p>Selected row: <code>{{JSON.stringify(selected)}}</code></p>
		
		<input value="{{value2}}" class="form-control autofill" on-keypress="@.onkeypress(@event)" />
		<div>
			<datatable url="https://api.themoviedb.org/3/search/movie?api_key=2498a34e67fe4a6a0a209316d830d942&query={{value2}}&page=1" prefix="results" headers="['Title', 'Release', 'Plot']" fields="['title','release_date','overview']" navigable="true" selectable="true"  selectedIndex="{{selectedIndex}}" />
		</div>
		
		
	</script>

	<script>
		var rows = [
		  {
			"_id": "5aec42c858af19316e84500d",
			"name": "Blackwell Welch",
			"email": "blackwellwelch@honotron.com",
			"age": 18,
			"isActive": false
		  },
		  {
			"_id": "5aec42c80f5d12b51c611d4c",
			"name": "Reyes Sheppard",
			"email": "reyessheppard@honotron.com",
			"age": 85,
			"isActive": false
		  },
		  {
			"_id": "5aec42c8992aac85cfbacac8",
			"name": "Burt Giles",
			"email": "burtgiles@honotron.com",
			"age": 34,
			"isActive": true
		  },
		  {
			"_id": "5aec42c8c2feef46725881c8",
			"name": "Ronda Travis",
			"email": "rondatravis@honotron.com",
			"age": 86,
			"isActive": false
		  },
		  {
			"_id": "5aec42c86ccbdaeeffbceee0",
			"name": "Aguirre Leon",
			"email": "aguirreleon@honotron.com",
			"age": 61,
			"isActive": false
		  }
		];
		
		Ractive.components['input-grid'] = Ractive.extend({
			template: `
					<div class="autofill">
						<input value="{{value}}" class="form-control" on-keypress="@.onkeypress2(@event)" />
						<div>
							<datatable rows="{{filteredRows}}" fields="{{fields}}" headers="{{headers}}" selected="{{selected}}" selectedIndex="{{selectedIndex}}" navigable="true" selectable="true" />
						</div>
					</div>`,
			computed: {
				filteredRows: function() {
					var value = this.get('value');
					var rows = this.get('rows');
					if( !value )
						return rows;
					
					var pattern = new RegExp(value, 'i')
					return rows.filter( row => row.name.search(pattern) >= 0 );
				}
			},
			onkeypress2: function(event) {
				var sel = this.get('selectedIndex') || 0;
				var len = this.get('filteredRows.length');
				console.log(sel + ' of ' + len);
				if( event.keyCode == 38 && sel > 0 ) // up
					this.set('selectedIndex', sel-1);
				else if( event.keyCode == 40 && sel < len-1 ) // down
					this.set('selectedIndex', sel+1);
				else if( event.keyCode == 13 ) {
					this.set('value', this.get('selected.name'));
				}
				else
					this.set('selectedIndex', 0)
			}
		})
		
		var ractive = new Ractive({
			target: '#target',
			template: '#template',
			data: {
				value: '',
				rows: rows,
				fields: ['name','email','age','isActive'], // not the '_id'
				headers: ['Name','Email', 'Age', 'Is active?'],
				selected: null,
				restricted: true
			},
			computed: {
				filteredRows: function() {
					var value = this.get('value');
					var rows = this.get('rows');
					if( !value )
						return rows;
					
					var pattern = new RegExp(value, 'i')
					return rows.filter( row => row.name.search(pattern) >= 0 );
				}
			},
			onkeypress: function(event) {
				var sel = this.get('selectedIndex');
				var len = this.get('filteredRows.length');
				
				if( event.keyCode == 38 && sel > 0 ) // up
					this.set('selectedIndex', sel-1);
				else if( event.keyCode == 40 && sel < len-1 ) // down
					this.set('selectedIndex', sel+1);
				else if( event.keyCode == 13 )
					this.set('value', this.get('selected.name'));
				else
					this.set('selectedIndex', 0)
			},
		});
	</script>
</body>
</html>
